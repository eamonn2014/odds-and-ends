---
title: "xxxxxxxxxxxxxx" 
author: 
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: scroll
    social: menu
    source_code: embed
runtime: shiny
---
tab 1
===



```{r global, include=FALSE}

  rm(list=ls())

  set.seed(64453)
  library(MASS)      # for neg binomial analysis and correlated data generation
  library(ggplot2)
  library(gridExtra)
    library(ggpubr)
  #library(lme4)
  library(shiny)
  library(utf8)      # codes for Greek letters
  library(MethComp)
  library(gridExtra)
  library(tidyverse)
  #library(car)       # diagnostics
  #library(vcd)       # diagnostics
  #library(skewsamp)  # power for neg binom
  lwd.=3             # used when plotting
  
  #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  # function to format decimals
  # https://stackoverflow.com/questions/3245862/format-numbers-to-significant-figures-nicely-in-r
  #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  formatz <- function(x){
    
    if (!is.na(x)  ) {
      
      formatC(signif(x,digits=5), digits=5,format="fg", flag="#",big.mark=",")
      
    }
    
  }
  
  formatz0 <- function(x){
    sprintf(x, fmt = '%s')  
  }
  formatz1 <- function(x){
    sprintf(x, fmt = '%#.1f')  
  }
  formatz2 <- function(x){
    sprintf(x, fmt = '%#.2f')  
  }
  formatz00 <- function(x){
    round(x,0) 
  }
  formatz3 <- function(x){
    sprintf(x, fmt = '%#.3f')  
  }
  formatz4 <- function(x){
    sprintf(x, fmt = '%#.4f')  
  }
  
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# function to generate cor data , see count app
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

mvrnorm <- function(n = 1, mu = 0, Sigma) {
  nvars <- nrow(Sigma)
  # nvars x n matrix of Normal(0, 1)
  nmls <- matrix(rnorm(n * nvars), nrow = nvars)
  # scale and correlate Normal(0, 1), "nmls", to Normal(0, Sigma) by matrix mult
  # with lower triangular of cholesky decomp of covariance matrix
  scaled_correlated_nmls <- t(chol(Sigma)) %*% nmls
  # shift to center around mus to get goal: Normal(mu, Sigma)
  samples <- mu + scaled_correlated_nmls
  # transpose so each variable is a column, not
  # a row, to match what MASS::mvrnorm() returns
  t(samples)
}
   


 # https://stackoverflow.com/questions/6461209/how-to-round-up-to-the-nearest-10-or-100-or-x/6468532#6468532
 # nice function from link to round to selected value

  roundUp <- function(x,to=10)
  {
    to*(x%/%to + as.logical(x%%to))
  }

 
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# start of app
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

```

Column {.sidebar}
-----------------------------------------------------------------------

**xxxxxxxxxxxxxxxx**

```{r tab1}

 
 
  sliderInput('n', 'n pairs of data', value=100,
                min = 5, max = 1000, step=5, ticks=F)

  sliderInput('mu0', 'Initial mean  \u03BC', value=0,
                min = -100, max = 100, step=5, ticks=F)
  
 
  sliderInput('eff.p', 'Effect of treatment', value = c(0),
                min = -25, max = 25 ,step=1, ticks=F)
  
   sliderInput('r', 'Correlation', value = c(.8),
                min = -.9, max = .9, step=0.05, ticks=F)
     
  sliderInput('sd.', 'Common SD', 1,
                min = 1, max = 100, step=1,ticks=F)
  
  selectInput("SD.type", "Select SD type", choices = c("cons", "lin"), selected="cons")
  
  selectInput("Dif.type", "Select difference type", choices = c("cons", "lin"), selected="cons")
  
  selectInput("Pl.type", "Select difference type", choices = c("BA", "conv"), selected="BA")
#
    #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
   # orange button
   actionButton("resample",   "Hit to simulate a new sample")
      
   #  tags$head(
   tags$style(HTML('#resample{background-color:orange}'))
   # )
  #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
 

```

$\alpha$ xxxxxxxxxxxxxxxxxxxx

xxxxxxxxxx $\alpha$ xxxxxxxxxxxxxxxxxxx

xxxxxxxxx $\alpha$ xxxxxxxxxxxxxxxxxxxxxxx

$\alpha$ xxxxxxxxxxxxxxxxxx 
 

Column {data-width=400, height=75}
-----------------------------------------------------------------------
### Chart 1

```{r tab1 plot1}
 
   # --------------------------------------------------------------------------
    # I looked back to two period cross over trial to get this button working to resimulate
    # This is where a new sample is instigated only random noise is required to be generated
    random.sample <- reactive({
      
    # Dummy line to trigger off button-press
    foo <- input$resample
         
    L1 <-     input$mu0
    L2 <-     input$mu0+input$eff.p
    r  <-     input$r
    n <-      input$n
    sd. <-    input$sd.
    
# generate correlated poisson ref: https://thomasward.com/simulating-correlated-data/
# Sample correlated N(0, 1) distributions from a multivariate normal distribution.
# Transform them to correlated Uniform(0, 1) distributions with the normal CDF.
# Transform them to any correlated probability distribution you desire with that probability distribution’s inverse CDF.

    Sigma <- matrix(c(1, r, r, 1), 2, 2)

    px <- mvrnorm(n, Sigma = Sigma)   # correlated continuous, see function in global area!

    U <- pnorm(px, mean = 0, sd = 1)  # correlated uniform
    
    pp1 <- qnorm(U[, 1], L1, sd.)      # correlated normal  
    pp2 <- qnorm(U[, 2], L2, sd.) 
        
    return(list(pp1=pp1, pp2=pp2, sd.=sd.))
     })
   
    # --------------------------------------------------------------------------


  r1 <- reactive({
 
    sample <- random.sample()
    
#    L1 <-     input$mu0
#     L2 <-     input$mu0+input$eff.p
     r  <-     input$r
     n <-      input$n
     sd. <-    sample$sd.  
#     
#  
# # generate correlated poisson ref: https://thomasward.com/simulating-correlated-data/
# # Sample correlated N(0, 1) distributions from a multivariate normal distribution.
# # Transform them to correlated Uniform(0, 1) distributions with the normal CDF.
# # Transform them to any correlated probability distribution you desire with that probability distribution’s inverse CDF.
# 
#     Sigma <- matrix(c(1, r, r, 1), 2, 2)
# 
#     px <- mvrnorm(n, Sigma = Sigma)   # correlated continuous, see function in global area!
# 
#     U <- pnorm(px, mean = 0, sd = 1)  # correlated uniform
#     
#     pp1 <- qnorm(U[, 1], L1, sd.)      # correlated normal  
#     pp2 <- qnorm(U[, 2], L2, sd.) 
     
     pp1 <- sample$pp1     # correlated normal  
     pp2 <- sample$pp2 
    
    cor. <- cor(pp1, pp2)              # capture correlation
 
    # create a data frame
    my_data <- data.frame( 
      group = rep(c("A.before", "B.after"), each = n),
      counts = c(pp1,  pp2),
      ID=rep(1:n,2)
    )

    ## variance of a difference from a simulation
    est <- var(pp1) + var(pp2) - 2 *cor. * sd(pp1) * sd(pp2)
    
    ## true variance of difference
    true <- sd.^2 + sd.^2 - 2 * r * sd. * sd.
    
    ## variance of a sum
    # var(pp1) + var(pp2) + 2 *cor. * sd(pp1) * sd(pp2)
    # 
    # 
    # sd.^2 +sd.^2 + 2 * r * sd.*sd.

 return(list( est=est, true=true , pp1=pp1, pp2=pp2 ))
     
  })
  
  # --------------------------------------------------------------------------
  h5(htmlOutput("text3"))      ## print 
  
```


```{r, test}
   # --------------------------------------------------------------------------
   # https://stackoverflow.com/questions/63507171/shiny-increase-mathjaxs-font-size
   # help on font size
   h5(htmlOutput("text2"))      
   # --------------------------------------------------------------------------
                              withMathJax(
                                tags$span(style="color:black;font-weight:bold;font-size: 20px;", 
                             helpText('
                             $${  
                             {\\sigma^2}{_{x \\pm y}} =  
                             {\\sigma^2}{_{x}}  +   {\\sigma^2}{_{y}} 
                             \\pm 2\\rho{\\sigma}{_{x}} {\\sigma}{_{y}}           
                             }\\!$$'
                             ))   
                             )
    # --------------------------------------------------------------------------
   h5(htmlOutput("text2a"))   
     
                            withMathJax(
                               tags$span(style="color:black;font-weight:bold;font-size: 20px;", 
                             helpText('
                              $${ 
                              \\rho {\\sigma}{_{x}}  {\\sigma}{_{y}}           
                              }\\!$$'))        
  
                            )
    # --------------------------------------------------------------------------
    h5(htmlOutput("text4"))   
    # --------------------------------------------------------------------------
```

 
```{r } 

  # --------------------------------------------------------------------------
output$text2 <- renderText({  # create interactive text t1

    print(paste0(   
    
    tags$span(style="color:black;font-weight:bold;font-size: 20px;", 
               
               "If the variables are uncorrelated the variance of the difference is equal to the sum of the variances. If there is any correlation this information is incorporated: ")))
  
})
  # --------------------------------------------------------------------------

output$text2a <- renderText({  # create interactive text t1

    print(paste0(   
    
    tags$span(style="color:black;font-weight:bold;font-size: 20px;", 
               
               "The following is the covariance between the two variables. We add 2 x this if we are interested in the variance of the sum, for the variance of the difference we subtract 2 x this component. ")))
  
})
   # --------------------------------------------------------------------------
   

output$text3 <- renderText({  # create interactive text t1

    print(paste0(   
    
    tags$span(style="color:black;font-weight:bold;font-size: 20px;", 
               
               "A method comparison with ") 
    
     , tags$span(style="color:blue;font-weight:bold;font-size: 20px;", input$n) ,
   
     tags$span(style="color:black;font-weight:bold;font-size: 20px;", 
               
               " samples assayed on each of two methods. There is a true bias of ") 
      
      , tags$span(style="color:blue;font-weight:bold;font-size: 20px;", input$eff.p) ,
     
     
        tags$span(style="color:black;font-weight:bold;font-size: 20px;", 
     
    ", also there is a true correlation between the paired results of ")
    
      , tags$span(style="color:blue;font-weight:bold;font-size: 20px;", input$r) ,
    
    
        tags$span(style="color:black;font-weight:bold;font-size: 20px;", 
    
    " and between sample sd commmon to both methods of ")
    
      , tags$span(style="color:blue ;font-weight:bold;font-size: 20px;", input$sd.) ,
    
     tags$span(style="color:black;font-weight:bold;font-size: 20px;",
               
    " There are no technical replicates ", #),
    
    
        ".") ))
  # --------------------------------------------------------------------------
 })
 

output$text4 <- renderText({  # create interactive text t1

    print(paste0(   

        tags$span(style="color:black;font-weight:bold;font-size: 20px;", 
               
               "Based on the true parameters, the variance of the difference is ") 
    
         , tags$span(style="color:blue ;font-weight:bold;font-size: 20px;",formatz3( r1()$true )),
                     
                     tags$span(style="color:black;font-weight:bold;font-size: 20px;", 
    
     ", this equates to an SD of the differences of ") 
    
       , tags$span(style="color:blue ;font-weight:bold;font-size: 20px;", formatz3(sqrt(r1()$true))) ,
    
     tags$span(style="color:black;font-weight:bold;font-size: 20px;", 
               
               ". The estimate from a simulated experiment is ") 
    
     , tags$span(style="color:blue ;font-weight:bold;font-size: 20px;", formatz3( r1()$est )),
                 
                  tags$span(style="color:black;font-weight:bold;font-size: 20px;", 
    
        ", this equates to an SD of the differences of ")
    
     , tags$span(style="color:blue ;font-weight:bold;font-size: 20px;", formatz3( sqrt(r1()$est)),
    
        ".") ))

 })
  # --------------------------------------------------------------------------
 
``` 


Column {data-width=400}
-------------------------------------

### Chart 3

```{r, tab1 plot3}

   # --------------------------------------------------------------------------
 

renderPlot({
  
  A <- r1()$pp1
  B <- r1()$pp2
  
  m <- ceiling(max(A,B))
  mL <- floor(min(A,B))
  before <- A #+ runif(length(A),-.2,.2) # had this jitter for counts but not needed for continuous
  after <-  B #+ runif(length(B),-.2,.2)
  n <- length(before)
  d <- data.frame(y = c(before, after), 
                  x = rep(c(1,2), each=n),
                  id = factor(rep(1:n,2)))
  
  d$xj <- jitter(d$x, amount=.13)
  # code from count app
  AA <- ggplot(data=d, aes(y=y) ) +
    geom_boxplot(aes(x=x, group=x), width=0.2, outlier.shape = NA, col='blue', fill='lightblue') +
    geom_line(aes(x=xj, group=id),  colour='pink', alpha=.5) +
    geom_point(aes(x=xj), size=2) +
    xlab("Phase") + ylab("Count") +  
    scale_x_continuous(breaks=c(1,2), labels=c("Before", "After"), limits=c(0.5, 2.5)) +
   # scale_y_continuous(breaks=c(mL:m), limits=c(mL,m)) +
    theme_bw() + theme(legend.position = "none") 
  
  #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ scatter plot
  

  d <- data.frame(y = B , x = A)
  
  BB <- ggplot(d, aes(x, y)) +
    geom_jitter(width = 0.1, height = 0.1, size=2) +
   #  scale_x_continuous(breaks=c(0:m), limits=c(mL,m)) +
   # scale_y_continuous(breaks=c(0:m), limits=c(mL,m)) +
    scale_x_continuous( limits=c(mL,m)) +
    scale_y_continuous(  limits=c(mL,m)) +
    xlab("Before count") +ylab("After count") +
    theme_bw() + theme(legend.position = "none") +
    geom_abline(intercept=0, slope=1)
  
  plot1 <- AA
  plot2 <- BB
  grid.arrange(plot1, plot2, ncol=2)


})
  # --------------------------------------------------------------------------


```

### Chart 4

```{r, tab1 plot4}

    
  # --------------------------------------------------------------------------


renderPlot({
  
    A <- r1()$pp1
    B <- r1()$pp2
    n <- input$n
    
    d <- data.frame(y = A , x = B)
  
    my_data <- data.frame( 
      group = rep(c("before", "after"), each = n),
      counts = c(d[,1],  d[,2]),
      ID=rep(1:n,2)
    )
  
   m <- Meth(my_data,meth="group",item="ID",repl=NULL,y="counts",print=TRUE)
   
   L <- max(abs(floor(min(A-B))),abs(ceiling(max(A-B))))
   
   L <- roundUp(L)
    
    # we set up const dif and const sd so that will matches true data genrting mechanism
    par( mfrow=c(1,1), mar=c(3,3,1,3), mgp=c(3,1,0)/1.6 )
   
    BA.plot( m, model=NULL, repl.conn=TRUE, col.lines="blue",
             # axlim=c(0,20), 
             diflim=c(-L,L), 
             xaxs="i", yaxs="i",
             las=1, eqn=TRUE,  
             pl.type=input$Pl.type, 
             sd.type=input$SD.type, 
             dif.type = input$Dif.type, # cons is simulatied
             grid=1:9*10, digits=3,font.eqn=1  , eqax=T)

})

  # --------------------------------------------------------------------------
 
```



tab2 $\alpha$
====

```{r, k or A}
  

  
```

```{r syntax, eval=TRUE, echo=TRUE}

 

#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# End
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

```
 
tab3
====

Column {.sidebar}
-----------------------------------------------------------------------


```{r gammapoisson}

    sliderInput('N.pg', 'Patients per arm', value=1000,
                  min = 1000, max = 100000, step=5, ticks=F)
    
    sliderInput('mu0.pg', 'Placebo event rate \u03BC per patient yr of follow up', value=1,
                  min = 0.1, max = 25, step=.05, ticks=F)
    
    sliderInput('eff.pg', 'Hypothesised treatment effect ', value=.75,  # 1/2 ing to doubling
                  min = 0.5, max = 2, step=.05, ticks=F)
  
    sliderInput('k.pg', 'This needs to be \u03B1 the heterogeneity (ancillary) parameter. \u03B1 = 1/k', value = 1.3 ,  
                  min = 0, max = 5 ,step=0.01, ticks=F)
    
    sliderInput('d1.pg', 'Placebo discontinuation prob', value = c(0.1),
                  min = 0, max = .5 ,step=0.05, ticks=F)
    
    sliderInput('d2.pg', 'Treatment discontinuation prob', value = c(0.1),
                  min = 0, max = .5 ,step=0.05, ticks=F)
  
    sliderInput('fup.pg', 'Follow up (yrs)', value = c(1),
            min = 1, max = 10, step=1,ticks=F)

```

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx 
 

Column {data-width=400, height=300}
-----------------------------------------------------------------------

### Constant SD assumption

```{r, gp barplots, eval=TRUE}

#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~



 
  r2 <- reactive({
 
    
    L1 <-     input$mu0
    L2 <-     input$mu0+input$eff.p
    r  <-     input$r
    n <-      input$n
    sd. <-    input$sd.
    

    A <- r1()$pp1
    B <- r1()$pp2
    n <- input$n
    
    d <- data.frame(y = A , x = B)
    
    my_data <- data.frame( 
      group = rep(c("before", "after"), each = n),
      counts = c(d[,1],  d[,2]),
      ID=rep(1:n,2)
    )
    
    m <- Meth(my_data,meth="group",item="ID",repl=NULL,y="counts",print=TRUE)
     
    
 
 #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  # code from my useful code, adjusted slightly

  BA <- DA.reg(m, DA.slope = TRUE)
  BA

  a1<-as.data.frame(unlist(BA))
  #DA.slope.p<-a1[14,]
  #cons.sd.p.value<-a1[38,]
  
  res<-rbind(a1[14,], a1[38,])
  res<-as.matrix(res)
  
  rownames(res)<-c( 
                   "DA Slope P-value",
                   "P-value for Changing SD")
  
  colnames(res) <- c("Bland Altman Analysis")
 # print(res)

  #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  ## **Assess Bland Altman assumptions P-values for two hypotheses:**
  w <- to.wide(m)
  ## assumptions do it yourself

  w$y <- w$before - w$after
  w$y <- w$after - w$before
  
  w$x <-  (w$before + w$after) /2
  
  # Constant difference - this is the test of 0 slope in the regression of differences on averages.
  f <- summary(lm(y~x, w))
  con.diff <- f$coefficients["x","Pr(>|t|)"]
  
  
  # Constant variance - this is the test of 0 slope in the regression of absolute residuals on averages.
  w$r <- abs(residuals(f) ) # if you dont use abs the regression line slope will be 0!
 # w$r <- (residuals(f) )
  #plot(r~x,w)
  f1 <- summary(lm(r~x, w))
  con.sd <- f1$coefficients["x","Pr(>|t|)"]
  
  ##
  # . A formal test of increasing or
  # decreasing variance by the level of measurement can be obtained by
  # first regressing the differences on the averages and then regressing the
  # absolute residuals from this on the averages 
  # 
  # library(ggplot2)
  # library(ggpubr)
  # ggplot(w, aes(x=x, y=r))+
  #   geom_point() +  
  #   geom_smooth(method="lm", col="black")  +
  #   stat_regline_equation(label.x = min(w$x), label.y = max(w$r))+
  #   theme_bw() +
  #   labs(title = paste0("Regression of absolute residuals on averages, p=", assump2),
  #        x = "Averages",
  #        y = "Absolute residuals")
   
  return(list( con.diff=con.diff, con.sd=con.sd , w=w ))
  

})

renderPlot({
  
w <- r2()$w
con.sd <- r2()$con.sd
  
  ggplot(w, aes(x=x, y=r))+
    geom_point() +  
    geom_smooth(method="lm", col="black")  +
    stat_regline_equation(label.x = min(w$x), label.y = max(w$r))+
    theme_bw() +
    labs(title = paste0("First regressing the differences on the averages and then regressing the absolute residuals from this on the averages.\nTesting hypothesis slope=0, p=", formatz3(con.sd)),
         x = "Averages",
         y = "Absolute residuals")
   
  
})





 

#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

``` 

### Constant difference assumption


```{r nb barplots, eval=TRUE}

#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
renderPlot({
  
w <- r2()$w
con.diff <- r2()$con.diff
 

  ggplot(w, aes(x=x, y=y))+
    geom_point() +  
    geom_smooth(method="lm", col="black")  +
    stat_regline_equation(label.x = min(w$x), label.y = max(w$r))+
    theme_bw() +
    labs(title = paste0("Regression of differences on averages.\nTesting hypothesis slope=0, p=", formatz3(con.diff)),
         x = "Averages",
         y = "After - before")
   
  
})
 
  
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~


```
   
Column {.tabset .tabset-fade}
-----------------------------------------------------------------------

### ads res
  

```{r diagnostics1, eval=TRUE}

renderPlot({
  
  w <- r2()$w
  con.diff <- r2()$con.diff
  
  mod1 <- lm(y ~ x, data = w) 
  w$pred = predict(mod1)  
  
  p <- w %>%
    ggplot(aes(x = x, y = y) ) +
    geom_point(pch = 21, color = "white", fill = "black", size = 2, alpha = 0.8) +
    geom_smooth(method = "lm", colour = "black", se=TRUE, level=.95, fill="purple") +
    stat_regline_equation(label.x = min(w$x), label.y = max(w$y))+
    
     labs(title = 
    paste0("Regression of differences on averages.\nTesting hypothesis slope=0, p=", formatz3(con.diff)),
         x = "Averages",
         y = "After - before") +

    geom_segment(
      aes(xend = x, yend = pred),
      size = 0.5, alpha = 0.5, lineend = "round", col="pink"
    ) +
    
    theme_bw(base_size = 12)
  
  print(p)

})


  

```

###  xxxxxxxxxxxxxxxxx
 
 
```{r diagnostics2}

# x averages
# y differences
# r abs residuals

renderPlot({
  
w <- r2()$w

  con.sd <- r2()$con.sd
  
  f <- summary(lm(y~x, w))
  w$r <- abs(residuals(f) ) 
  mod1 <- lm(r ~ x , data = w) 
  w$pred = predict(mod1) # pred and fitted no dif on linear model
  w$pred = fitted(mod1) 
  
  
p1 <-  ggplot(w, aes(x=x, y=r))+
    geom_point(pch = 21, color = "white", fill = "black", size = 2, alpha = 0.8) +
    geom_smooth(method = "lm", colour = "black", se=TRUE, level=.95, fill="purple") +
    stat_regline_equation(label.x = min(w$x), label.y = max(w$r))+
    theme_bw() +
    labs(title = paste0("First regressing the differences on the averages and then regressing the absolute residuals from this on the averages.\nTesting hypothesis slope=0, p=", formatz3(con.sd)),
         x = "Averages",
         y = "Absolute residuals") +
    
    geom_segment(
      aes(xend = x, yend = pred),   ## trying to join to reg line
      size = 0.5, alpha = 0.3, lineend = "round", col="pink"
    ) +
    
    theme_bw(base_size = 12)

  print(p1)
   
  
})
  

```

### xxxxxxxxxxxxxxxxx
  

```{r diagnostics3, eval=TRUE}
 


```

### xxxxxxxxxxxxxxx 
 
 
```{r diagnostics4}

  
```

### xxxxxxxxxxxxxxx
 
 
```{r diagnostics5}

   

```

### xxxxxxxxxxxxx

```{r diagnostics6, eval=TRUE}

  
``` 
 

tab 4
====

Column {.sidebar}
-----------------------------------------------------------------------

xxxxxxxxxxxxxxxxxxxxxxxxxxxxx

```{r, main power tab2}
 
    sliderInput('N', 'Patients per arm', value=174,
                  min = 10, max = 1000, step=5, ticks=F)

    sliderInput('mu0', 'Placebo event rate \u03BC per patient yr of follow up', value=1.5,
                  min = 0.1, max = 25, step=.05, ticks=F)

    sliderInput('eff', 'Hypothesised treatment effect ', value=.6, 
                  min = 0.1, max =5, step=.01, ticks=F)

    sliderInput('k', 'This needs to be \u03B1 the heterogeneity (ancillary) parameter. \u03B1 = 1/k', value = 1.3 , #c(10/13),
                  min = 0, max = 5 ,step=0.1, ticks=F)

    sliderInput('d1', 'Placebo discontinuation prob', value = c(0),
                  min = 0, max = .5 ,step=0.05, ticks=F)

    sliderInput('d2', 'Treatment discontinuation prob', value = c(0),
                  min = 0, max = .5 ,step=0.05, ticks=F)

    sliderInput('fup', 'Follow up (yrs)', value = c(1),
            min = 1, max = 10, step=1,ticks=F)

    sliderInput('sims2', 'Power simulations', value= 500,
                  min = 500, max = 10000, step= 500, ticks=F)
    
    checkboxInput('perc1','show stats on barplot', value = TRUE)


```

Row {data- height=650}
-----------------------------------------------------------------------
### xxxxxxxxxxxxxxxxxxxxxxxxxxxx
  
```{r text power, eval=TRUE}

 
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

reactive({
  
cat(paste0("xxxxxxxxxxxxxxx"))
})
  

```
 
Row {data-height=700}
-------------------------------------
   
### xxxxxxxxxxxxxxxxxx

```{r power typical barplot}

#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

 

 
```   
 
   
### xxxxxxxxxxxxxxxxxxxx 1/$\alpha$

```{r power typ output}

 
  
``` 

tab 5
====

Column {.sidebar}
-----------------------------------------------------------------------


```{r power canned}
  
 
 
```

Row {data-height=600}
-----------------------------------------------------------------------

### **xxxxxxxxxxxxxxx $\\alpha$.**

```{r power canned result, eval=TRUE}

 

 
```

tab 6
====

Column {.sidebar}
-----------------------------------------------------------------------


Use the inputs below to generate correlated count data !

```{r paired}

  sliderInput('N.p', 'Patients per arm', value=28,
                min = 10, max = 200, step=5, ticks=F)
  
  sliderInput('mu0.p', 'Placebo mean rate \u03BC', value=8,
                min = 0.1, max = 25, step=.05, ticks=F)
  
  sliderInput('eff.p', 'Hypothesised treatment effect ', value=.75,   
                min = 0.5, max = 2, step=.05, ticks=F)
  
  sliderInput('r', 'Correlation', value = c(.20),
                min = -1, max = 1 ,step=0.05, ticks=F)
   
  sliderInput('sims.p', 'Power simulations', value= 10,
                min = 10, max = 1000, step= 100, ticks=F)

```

Row {data-height=275}
-----------------------------------------------------------------------

### xxxxxxxxxxxxxxxx
  

```{r paired txt, eval=TRUE}

reactive({
  
cat(paste0("xxxxxxxxxxx ",input$N.p,"xxxxxxxxxxxxxxx.\n"))

cat(paste0("xxxxxxxxxxxxxxxxxxxx ",input$mu0.p, " xxxxxxxxxxxxxxxx ",input$eff.p,", xxxxxxxxxx " ,input$r,".\n")) 

cat(paste0("\nxxxxxxxxxxxxxxxx"))

cat(paste0("\nxxxxxxxxxxxxxxxxxx"))
cat(paste0("\n1) xxxxxxxxxxxx"))
cat(paste0("\n2) xxxxxxxxxxxx"))
cat(paste0("\n3) xxxxxxxxxxxx"))
 
})

``` 

Row {data-height=250}
-----------------------------------------------------------------------

### tab4


```{r paired results, eval=TRUE}

 
```

   
Row {.tabset .tabset-fade}
-----------------------------------------------------------------------

### tab5
  

```{r paired boxplot, eval=TRUE}

#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

   

```

### tab6

```{r BAplot}

  

```

Wiki
====
 
xxxxxxxxxxxxxxxxxxxxxxxxx $\alpha$ xxxxxxxxxxxxxxxxxxxxxxxxxx

**xxxxxxxxxxxxxxxxxxxxxxx**

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx  

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx 

References
====
```{r, refs}
 
    tags$a(href = "https://pubmed.ncbi.nlm.nih.gov/8337548/", target="_blank",
           tags$span(style="color:blue", "[1] Construction of age-related reference centiles using absolute residuals, Doug Altman shows how to model the SD"),) 
    div(p(" "))
    # tags$a(href = "https://stats.stackexchange.com/questions/27869/fitting-a-poisson-glm-mixed-model-with-a-random-slope-and-intercept",target="_blank",
    #        tags$span(style="color:blue", "[2] Mixed model Poisson"),)
    # div(p(" "))
    
    div(p(" "))
  tags$hr()                        

```