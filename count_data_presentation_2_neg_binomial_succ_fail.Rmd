---
title: "Negative binomial distributions" 
author: 
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: scroll
    social: menu
    source_code: embed
runtime: shiny
---
 

```{r global, include=FALSE}

  rm(list=ls())
  set.seed(6453)
  library(MASS)      # for neg binomial analysis and correlated data generation
  library(ggplot2)
  library(shiny)
  library(utf8)      # codes for Greek letters
  library(gridExtra)
  library(tidyverse)
  options(width=200)
 
  lwd.=3             # used when plotting
  
  #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  # function to format decimals
  # https://stackoverflow.com/questions/3245862/format-numbers-to-significant-figures-nicely-in-r
  #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  formatz <- function(x){
    
    if (!is.na(x)  ) {
      
      formatC(signif(x,digits=5), digits=5,format="fg", flag="#",big.mark=",")
      
    }
    
  }
  
  formatz0 <- function(x){
    sprintf(x, fmt = '%s')  
  }
  formatz1 <- function(x){
    sprintf(x, fmt = '%#.1f')  
  }
  formatz2 <- function(x){
    sprintf(x, fmt = '%#.2f')  
  }
  formatz00 <- function(x){
    round(x,0) 
  }
  formatz3 <- function(x){
    sprintf(x, fmt = '%#.3f')  
  }
  formatz4 <- function(x){
    sprintf(x, fmt = '%#.4f')  
  }
  
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# function for nice upper limits to count bar plots, stack exchange
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  
  roundUpNice <- function(x, nice=c(1,1.5, 2,4,5,6,8,10)) { #added 1.5 to help bar plot y scale
    if(length(x) != 1) stop("'x' must be of length 1")
    10^floor(log10(x)) * nice[[which(x <= 10^floor(log10(x)) * nice)[[1]]]]
  }
  
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# Define the Negative Binomial probability density function, with parameters
# mu and alpha. The mean of this NB distribution is mu, and variance is sigma^2=mu+alpha*mu^2
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    
   e_dnbinom=function(x,mu,alpha){
     
    k = 1/alpha
    s1 = lgamma(k+x)-lgamma(k)-lgamma(x+1)    # lgamma is log(gamma)
    s2 = x*log(mu/(mu+k))
    s3 = -k*log(1+mu/k)
    prob = exp(s1+s2+s3)
    prob[x<0] = 0
    prob[prob>1] = 1
    prob[prob<0] = 0
    return(prob)
    
  }

   # write an equivalent to e_dnbinom see link for Probability Mass Function on page 1
   # this is not used but just  a qc check, this is a useful doc
   # file:///C:/Users/Lenovo/OneDrive/Documents/PAPERS/COUNT%20DATA/Gamma-Poisson%20Distribution%20_%20const-ae.pdf
   check <- function(x, mu, alpha) {
      y=x
      s1 <- lgamma(y+1/alpha)-lgamma(1/alpha)-lgamma(y+1)
      s2 <- y*log((mu^2*alpha)/(mu+mu^2*alpha))
      s3 <- (1/alpha)*log(1/(1+mu*alpha))
      prob=exp(s1+s2+s3)
      return(prob)
  }

# checking self written functions
  x <- runif(1)
  check(    1, alpha=x,    mu=3)
  dnbinom(  1, size=1/x,   mu=3)
  e_dnbinom(1, alpha=x,    mu=3)

#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# This function translates the mu and alpha parameters into size and prob
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    
  e_rnbinom=function(n,mu,alpha){
    size = 1/alpha          # so now we can just enter alpha this is converted to 1/ alpha
    prob = size/(mu+size)   # so now we can enter mu the mean and that is converted to prob
    return(rnbinom(n,size=size,prob=prob))
  }

  #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  
   e_nb=function(mu,alpha){
     size = 1/alpha          # so now we can just enter alpha this is converted to 1/ alpha
     prob = size/(mu+size)   # so now we can enter mu the mean and that is converted to prob
     return(list(prob=prob,size=size))
   }
   
  #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  # here is where prob and size are converted to mu and alpha
  # https://geek-questions.imtqy.com/articles/1785935/index.html
   rev_nb=function(prob,size){
    alpha = 1/size           # so now we can just enter alpha this is converted to 1/ alpha
    mu = size/prob - size    # so now we can enter mu the mean and that is converted to prob
    return(list(mu=mu, alpha=alpha))
   }
  #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  # another qc check
    x <- e_nb(mu=15, alpha=1.2)
    x
    rev_nb(size=x$size, prob=x$prob)
    # 
    # x<-10
    # k = 1.2
    # mu = 15
    # 
    # p = k/(k+mu)   #1
    # s = mu*p/(1-p) #2
    # 
    # dnbinom(x,size=s,prob=p)
    # dnbinom(x,mu=mu,size=k)
    #  
    # mu <- ( k/p - k )     

#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# number of successes function, to simulate neg binomial simulation
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  
 foo <- function(p = 0.5, s = 4) { # p prob of success; s 
  
  i <- 0 # count of how many attempt we need to get s successes
  x <- 0 # use this to know when to stop function
  
  while ( x < s) {  # stop when x equals s 
    
    i <- i + 1  # count every attempt
    
    res <-  rbinom(1, size=1, prob=p)  # Ala coin flip, heads is success
    
    if (res ==1) {x = x + 1}           # if heads count, if not we fail
   
  }
  return(i) # result captured here
}

#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# start of app
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
 
 
```

Wiki {data-icon="fa-home"}
====================================

<!-- column {data-height=600} -->
<!-- ------------------------------------ -->


```{r}

h5(htmlOutput("intro1")) 
br()
h5(htmlOutput("intro2")) 
br()
h5(htmlOutput("intro3")) 
br()
#-------------------------------------------------------------------------------------------------------

 output$intro1 <- renderText({  # create interactive text t1

 
    print(paste0(
      
       tags$span(style="color:blue;font-weight:bold;font-size: 20px;", 
               
               "Introduction")   ,
      br(), 
         br(), 
          br(), 
     tags$span(style="color:black;font-weight:bold;font-size: 20px;", 
               
               "Exploration of a not so well known, but common distribution used in the analysis of count data...the negative binomial distribution") ,
      
       "."))

 })


 output$intro2 <- renderText({  # create interactive text t1

 
    print(paste0(
      
       tags$span(style="color:black;font-weight:bold;font-size: 20px;", 
               
               "Imagine a basketball player, whose average success at dunking a basketball has probability 50%. The negative binomial distribution can be used to answer what is the probability of the rth dunk/success on the xth throw. Or, how long does it take to get pregnant? Or, a large lot of tyres contains 4% defectives. 4 tyres are to be chosen for a car. Find the probability that you find 2 defective tyres before 4 good ones. The probability of male birth is 0.5. Another example, a couple wish to have children until they have exactly two female children in their family. What is the probability that the family has four children?")   ,
    #  br(), 
    #     br(), 
     #      br(),
   tags$span(style="color:black;font-weight:bold;font-size: 20px;", 
               
               " ") ,
      
       "."))

 })
 
 
 
 output$intro3 <- renderText({  # create interactive text t1

 
    print(paste0(
      
       tags$span(style="color:black;font-weight:bold;font-size: 20px;", 
               
               "For modelling occurrences of discrete events, like tornado outbreaks, the negative binomial distribution can be used to give more accurate models than the Poisson distribution by allowing the mean and variance to be different. The negative binomial distribution has a variance mu /(1-p), with the distribution becoming identical to Poisson in the limit p -> 0 for a given mean mu (p is the probability of success in each experiment). This can make the distribution a useful overdispersed alternative to the Poisson distribution. So it may be appropriate where events have positively correlated occurrences causing a larger variance than if the occurrences were independent, due to a positive covariance term. [Wikipedia]")   ,
      br(), 
      #   br(), 
       #    br(),
   tags$span(style="color:black;font-weight:bold;font-size: 20px;", 
               
               " ") ,
      
       "."))

 })
 
 
 
 
  



```

PMFs two alternative formulations of negative binomial {data-icon="fa-cog"}
===

Column {.sidebar}
-----------------------------------------------------------------------

**Count data analysis is explored**

```{r tab1}

  #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 

  sliderInput('mu', 'Top panels \u03BC', value=3,
                min = 1, max = 25, step=.5, ticks=F)
  
  sliderInput('alpha_a', 'Top panels \u03B1', value = c(.5),  #1/3
                min = 0, max = 3 ,step=0.01, ticks=F)
 
  sliderInput('P', 'Prob. of Success (bottom panels)', value=.4, #.5
                min = 0.01, max = 1, step=.01, ticks=F)
  
  sliderInput('s', 'No of successes (bottom panels)', value = c(2), #3
                min = 1, max = 100 ,step=1, ticks=F)
  
  #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
  
  sliderInput('sims', 'Simulations (bottom left panel)', 15000,
                min = 1000, max = 20000, step=1000,ticks=F)
  
  sliderInput('x_range', 'Plot x-range', value = c(0,10),
          min = 0, max = 80,step=5,ticks=F)
  
  sliderInput('y_range', 'Plot y-range', value = c(0,.25),
          min = 0, max = 1,step=.05,ticks=F)

  checkboxInput('perc','show stats on barplot', value=TRUE)

  #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 

```

$\alpha$ takes on positive rational values, rarely above 4. Values of $\alpha$ greater than 2 usually indicate that there is substantial over-dispersion.

When $\alpha$ approaches 0, k approaches infinity and Poisson emerges (move $\alpha$ slider to 0).

When $\alpha$ > 1, k < 1 leads to over dispersed data.

$\alpha$ = 1/k ; k = 1/ $\alpha$ see next tab.
 

Column {data-width=400, height=300}
-----------------------------------------------------------------------
### Negative binomial couched in terms of mu and alpha


```{r tab1 plot1, eval=TRUE}

  
        renderPlot({
          
          par(mar=c(5.1, 4.1, 4.1, 7.1), mgp=c(3, 1, 0), las=0) ;
  
          mu = input$mu
          alpha_a = input$alpha_a
              
          low =  input$x_range[1]
          xmax=  input$x_range[2]
          ymax = input$y_range[2]

#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

  xx <- c(seq(0,xmax,1)) 

  if(alpha_a==0) { # if alpha = 0, force Poisson to avoid error
    yb = dpois(xx,mu)
  }else{
    yb=  e_dnbinom(xx,mu,alpha_a)
  }

  b <- barplot(yb, xlim=c(0,xmax+2), ylab = "Percent", xlab="Count of failed attempts (X-r)", col='lightgreen',
          ylim=c(0,ymax),
          main =  paste0("Negative Binomial \u03BC = ",mu," \u03B1 = ",formatz2(alpha_a),", variance = ", (mu+alpha_a*mu^2),""), # mu+alpha_a*mu^2* alpha_a
          names.arg= as.character(xx))
  
  if(input$perc) {
    x  <- 0:length(b) # % onto top of bars
    y1 <- yb + 0.02
    z  <- round(yb,2) *100
    z  <- paste0(z,"%")
    text(x=b[x+1],y=(y1),labels=z, cex = 1)
  }
  par(mar=c(5.1, 4.1, 4.1, 2.1), mgp=c(3, 1, 0), las=0)
})

    
 
```

### Negative binomial mu and alpha converted to probability of success and number of successful attempts  

```{r, tab1 plot2, eval=TRUE}

  renderPlot({
    
  par(mar=c(5.1, 4.1, 4.1, 7.1), mgp=c(3, 1, 0), las=0) ; 
    
  sim <- input$sims
  # P <- input$P   # randomly pick a probability
  
 # if (input$alpha_a==0) {a=1} else { a = input$alpha_a } # stop plot error
  
  
  z <- e_nb(input$mu, input$alpha_a)
 
  P = z[1][[1]]
  s = z[2][[1]]
  
  #low =  input$x_range[1]
  xmax=  input$x_range[2]
  ymax = input$y_range[2]
 # ymin = input$y_range[1]

  
  # zz <- rev_nb(P, s)
  # muz = zz[1][[1]]
  # alphaz = zz[2][[1]]
  # simulation bar plot
  #!!!!!!!!!!!!!!!!!!!!!!this is actually not used
  number_of_attempts <- replicate(sim, foo(p=P,s=s))  # run function many times
   
  Tm <-  1/P*s 
  Sm <- mean(number_of_attempts) 
  
  x <- table(factor(number_of_attempts, levels = s: max(number_of_attempts))) # pad out so levels so no counts included
   
  m = length(x)-1
  z <- formatz2((0:m)+s) # labels
  d <- dnbinom(0:m, prob=P, size=s)
  b <- barplot(d , #x/sim, 
               
               xlim=c(0,xmax+2),  
               ylim=c(0,ymax),
               main = paste0("Number of attempts until we reach ",s," successes when p=",formatz2(P),
                                    "\n True \u03BC ",formatz2(Tm) ,""),
               col="orchid1", 
               ylab="Probability of success", 
               xlab="Attempts for success (no simulation); note we can get non-integers!",
               names.arg= as.character(z))
  
  # overlay true neg binomial dist.
  #m <- length(b)-1
 
#  d <- dnbinom(0:m, prob=P, size=s) # s was 0 and ymax was m
# no need for these points and lines...
# lines( x = b, y = d , col='red')
 # points(x = b, y = d , col='red')
 
    if(input$perc) {
      
        x  <-0:length(b) # % onto top of bars
        y1 <- d + 0.02
        z  <- round(d,2) *100
        z  <- paste0(z,"%")
        text(x=b[x+1],y=(y1),labels=z, cex = 1)
    }
  par(mar=c(5.1, 4.1, 4.1, 2.1), mgp=c(3, 1, 0), las=0)
  })

```

Column {data-width=400}
-------------------------------------

### Negative binomial couched in terms of probability of success and number of successesful attempts

```{r, tab1 plot3, eval=TRUE}
 
 renderPlot({
   
  par(mar=c(5.1, 4.1, 4.1, 7.1), mgp=c(3, 1, 0), las=0) ; 
   
  sim <- input$sims
  P <- input$P   # randomly pick a probability
  if (P==0) {P=0.01}
  s <- input$s   # randomly pick nth success
  
  #low =  input$x_range[1]
  xmax=  input$x_range[2]
  ymax = input$y_range[2]
 # ymin = input$y_range[1]
   
  # simulation bar plot
  number_of_attempts <- replicate(sim, foo(p=P,s=s))  # run function many times
  
  #Tm <- s*(1-P)/P + s
  Tm <-  1/P*s 
  Sm <- mean(number_of_attempts) 
  
 
  x <- table(factor(number_of_attempts, levels = s: max(number_of_attempts))) # pad out so levels so no counts included
 # x <- table(factor(number_of_attempts, levels = s: ymax)) # pad out so levels so no counts included

  b <- barplot(x/sim, 
               
               xlim=c(0,xmax+2),  
               ylim=c(0,ymax),
               main = paste0("Number of attempts until we reach ",s," successes when p=",formatz2(P),
                                    "\n True \u03BC ",formatz2(Tm) ," ; Simulated \u03BC (lilac) ",formatz2(Sm) ,""),
                                    
               col="orchid1", 
               ylab="Probability of success", 
               xlab="Attempts for success (simulated in lilac, true negative binomial distribution red line with true %s above bars)")
  
  # overlay true neg binomial dist.
  m <- length(b)-1
 
  # d <- dnbinom(s:ymax, prob=P, size=s) # s was 0 and ymax was m
  
  d <- dnbinom(0:m, prob=P, size=s) # s was 0 and ymax was m

  lines( x = b, y = d , col='red')
  points(x = b, y = d , col='red')
 
    if(input$perc) {
      
        x  <-0:length(b) # % onto top of bars
        y1 <- d + 0.02
        z  <- round(d,2) *100
        z  <- paste0(z,"%")
        text(x=b[x+1],y=(y1),labels=z, cex = 1)
  }
par(mar=c(5.1, 4.1, 4.1, 2.1), mgp=c(3, 1, 0), las=0)

 })

```

###  Negative binomial probability of success and number of successful attempts converted to mu and alpha

```{r, tab1 plot4}

    renderPlot({
      
    par(mar=c(5.1, 4.1, 4.1, 7.1), mgp=c(3, 1, 0), las=0) 
      
    z <-  rev_nb(input$P, input$s)
    
    mu = z[1][[1]]
    alpha_a = z[2][[1]]
        
    low =  input$x_range[1]
    xmax=  input$x_range[2]
    ymax = input$y_range[2]

#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

  xx <- c(seq(0,xmax,1)) 

  if(alpha_a==0) {
    yb =    dpois(xx,mu)
  }else{
    yb=     e_dnbinom(xx,mu,alpha_a)
  }

  b <- barplot(yb, xlim=c(0,xmax+2), ylab = "Percent", xlab="Count of failed attempts (X-r)", col='lightgreen',
          ylim=c(0,ymax),
          main =  paste0("Negative Binomial \u03BC = ",mu," \u03B1 = ",formatz2(alpha_a),", variance = ", mu+alpha_a*mu^2,""),
          names.arg= as.character(xx))
  
  if(input$perc) {
    x  <- 0:length(b) # % onto top of bars
    y1 <- yb + 0.02
    z  <- round(yb,2) *100
    z  <- paste0(z,"%")
    text(x=b[x+1],y=(y1),labels=z, cex = 1)
  }
   par(mar=c(5.1, 4.1, 4.1, 2.1), mgp=c(3, 1, 0), las=0)
})

```

PMFs of two alternative formulations of negative binomial ii {data-icon="fa-rocket"}
===


Column {.sidebar}
-----------------------------------------------------------------------

**The negative binomial distribution asks : what is the probability that the rth success will occur on the kth trial, where k varies from r to infinity, given a fixed r, and a fixed probability of success on each trial?**

```{r tab1x}

  #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
 
  sliderInput('Px', 'Probability of Success (p)', value=.4, #.5
                min = 0.01, max = 1, step=.01, ticks=F)
  
  sliderInput('sx', 'No of successes (r)', value = c(2), #3
                min = 1, max = 50 ,step=1, ticks=F)

  sliderInput('x_rangex', 'Plot x-range', value = c(0,10),
          min = 0, max = 80,step=5,ticks=F)
  
  sliderInput('y_rangex', 'Plot y-range', value = c(0,.25),
          min = 0, max = 1,step=.05,ticks=F)

  checkboxInput('percx','show stats on barplot', value=TRUE)

  #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 


```

Recall that a binomial random variable is a count of the number of successes in n Bernoulli
trials. That is, the number of trials is predetermined, and the number of successes is random.
A negative binomial random variable is a count of the number of trials required to obtain r successes. That is, the number of successes is predetermined, and the number of trials is random

Column {data-width=400} 
-----------------------------------------------------------------------

### Negative binomial couched in terms of probability of success and number of successesful attempts


```{r, tab1 plot3x, eval=TRUE}
 
 renderPlot({

     par(mar=c(5.1, 4.1, 4.1, 7.1), mgp=c(3, 1, 0), las=0) # http://rfunction.com/archives/1302

  P <- input$Px   # probability of success
  if (P==0) P=0.01
  s <- input$sx   # th success

  
  mu  <- s / P
  mu2 <- (s*P)/(1-P)
  #mean(rnbinom(n = 10000, size = s, prob = p)) + s
  # https://bookdown.org/mpfoley1973/data-sci/negative-binomial.html
  # Variance of distribution = (Number of success*Probability of Failure)/(Probability of Success^2)
  #~~~~~~~~~~~~~~~~~~~~~~~~~~~~
   
  #~~~~~~~~~~~~~~~~~~~~~~~~
  # Wikipedia: 

  v  <- s * (1 - P) / P^2   #  When counting the number of failures  before the r-th success, the variance is r(1 − p)/p2.
  v2 <- s * P/ ((1 - P)^2)    # When counting the number of successes given the number r of failures, the variance is rp/(1 − p)2.
  ef <- s * (1 - P) / P
  #s=3;P=0.2
  #x <- rnbinom(n = 100000, size = s, prob = P)
  #mean(x);var(x)
  
 
  #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  
  xmax=  input$x_rangex[2]
  ymax = input$y_rangex[2]

  xx <- c(seq(0,xmax,1)) 
  d <- dnbinom(0:max(xx), prob=P, size=s) #

  b <- barplot(d, 
               xlim=c(0,xmax+2),  
               ylim=c(0,ymax),
               main = paste0("Probability of ",s," successes on kth trial when probability of success is ",formatz2(P), ". Average number of trials \u03BC (r/p) = ",formatz2(mu) ,";\nThe expected number of failures prior to r successes is r(1-p)/p = ",formatz2(ef)," with variance r(1-p)/p^2 = ",formatz2(v),"\n"),
                             
                             # 
                             # 
                             # \nAverage number of successes rp/(1 − p) = ",formatz2(mu2),". Counting the number of successes given the number r of failures, the variance is rp/(1 − p)^2 = ",formatz2(v2),"\n"),
                                    
               col="orchid1", 
               ylab="Probability of success", 
               xlab=paste("Attempts for ",s," successes"),
               names.arg= as.character(xx+s))
 
 
    if(input$percx) {
      
        x  <-0:length(b) # % onto top of bars
        y1 <- d + 0.02
        z  <- round(d,4) *100
        z  <- paste0(z,"%")
        text(x=b[x+1],y=(y1),labels=z, cex = 1)
  }
par(mar=c(5.1, 4.1, 4.1, 2.1), mgp=c(3, 1, 0), las=0)
 })


 

```

Column {data-width=400}
-------------------------------------

### barplot

```{r, tab1 plot4x, eval=TRUE}

renderPlot({
  
  par(mar=c(5.1, 4.1, 4.1, 7.1), mgp=c(3, 1, 0), las=0)
  
    z <- rev_nb(input$Px, input$sx)  #  # here is where prob and size are converted to mu and alpha
    
    mu      = z[1][[1]]
    alpha_a = z[2][[1]]
        
    low =  input$x_rangex[1]
    xmax=  input$x_rangex[2]
    ymax = input$y_rangex[2]
 
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

  xx <- c(seq(0,xmax,1)) 

  if(alpha_a==0) {
    yb =    dpois(xx,mu)
  }else{
    yb=     e_dnbinom(xx,mu,alpha_a)
  }

# check the variance calculation
  
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# my code from when ttests won't do
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  # value <- 0:200
  # freq <- e_dnbinom(value, alpha=1/3,mu=3)*100
  # 
  # mu<-sum(freq*value)/sum(freq)
  # va<-(sum(freq*(value-mu)^2)/(sum(freq)-1) ) 
  # 
  # mu
  # va
  # #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  # freq <- dnbinom(value, size3,mu=3)*100
  # 
  # mu<-sum(freq*value)/sum(freq)
  # va<-(sum(freq*(value-mu)^2)/(sum(freq)-1) ) 
  # 
  # mu
  # va
  
  
  e_nb(mu=3, alpha=.5)
  
  # lets do a sanity check on mean and variance and report them as qc check in plot
  value <-   0:1000000   # replaced xx 
  freq  <-  e_dnbinom(value, alpha=alpha_a,mu=mu)*100
  (mux   <-  sum(freq*value)/sum(freq))
  (vax   <- (sum(freq*(value-mu)^2)/(sum(freq)-0) ) )# I changed the 0 from 1 !!
  
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# end 
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

  
  
  b <- barplot(yb, xlim=c(0,xmax+2), ylab = "Percent", xlab="Count of failed attempts (X-r)", col='lightgreen',
          ylim=c(0,ymax),
          main =  paste0("Negative Binomial \u03BC = ",formatz2(mu)," \u03B1 = ",formatz2(alpha_a),", variance = ", formatz2(mu+alpha_a*mu^2)," [qc check mu =  ",formatz2(mux),"; qc check variance = ",formatz2(vax),"]"),
          names.arg= as.character(xx))
  
  if(input$percx) {
    x  <- 0:length(b) # % onto top of bars
    y1 <- yb + 0.02
    z  <- round(yb,4) *100
    z  <- paste0(z,"%")
    text(x=b[x+1],y=(y1),labels=z, cex = 1)
    
    par(mar=c(5.1, 4.1, 4.1, 2.1), mgp=c(3, 1, 0), las=0)
  }
})

# qc ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# r <- 15
# p <- 0.06
# my_dat <- rnbinom(n = 10000, size = r, prob = p) + r
#   mean(my_dat)  # end of line 1 in top plot title
#   r / p
# 
# my_dat <- rnbinom(n = 10000, size = r, prob = p)
#   mean(my_dat) # start of line 2 in top plot title
#   r*(1-p)/p
#   var(my_dat)  # end of line 2
#   r * (1 - p) / p^2
# 
# A <- rnbinom(n = 10000, size = r, prob = 1-p)
#   mean(A)   # start of line 3 in top plot title
#   var(A)    # end of line 3 in top plot title
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

#  barplot(table(my_dat))
  

```

Row  
-------------------------------------

### new

```{r, tab4, eval=TRUE}


 h5(htmlOutput("text3"))      ## print text1
  
#-------------------------------------------------------------------------------------------------------
 
   output$text3 <- renderText({   
     
    p <- input$Px  # prob
    r <- input$sx  # rth success
    
    print(paste0(                                                               # text

     tags$span(style="color:black;font-weight:bold;font-size: 20px;",

               "Here we obtain the probability for the trial at which the rth success occurs :")
   ))
    

 })

 # HTML("\nHere we obtain the probability for the trial at which the rth success occurs :")
   br()
 
 withMathJax(
                                           helpText('
                              $${P(X_1 = x|p,r) =\\binom{x-1}{r-1} p^r(1-p)^{(x-r)}}\\!$$'))
    
  br()
  
  
  h5(htmlOutput("text4"))      ## print text1
  
#-------------------------------------------------------------------------------------------------------
 
   output$text4<- renderText({   
     
    p <- input$Px  # prob
    r <- input$sx  # rth success
    
    print(paste0(                                                               # text

     tags$span(style="color:black;font-weight:bold;font-size: 20px;",

               "Here we obtain the probability for the number of failed trials before the rth success:")
   ))
    

 })
  
 #HTML("Here we obtain the probability for the number of failed trials before the rth success:")

 withMathJax(
                                           helpText('
                             $${P(X_2 = x|p,r) =\\binom{r+x-1}{x} p^r(1-p)^{x}}\\!$$'))
 
  br()

  
  ###~
  
  h5(htmlOutput("text2"))      ## print text1
  
#-------------------------------------------------------------------------------------------------------
# 
   output$text2 <- renderText({  # create interactive text t1
    
    p <- input$Px  # prob
    r <- input$sx  # rth success
    
    print(paste0(                                                               # text

    tags$span(style="color:blue;font-weight:bold;font-size: 20px;", 

            )   ,
      br(),
      br(),
     tags$span(style="color:black;font-weight:bold;font-size: 20px;",

               "The probability of success p is  ")

      , tags$span(style="color:blue;font-weight:bold;font-size: 20px;", p) ,


        tags$span(style="color:black;font-weight:bold;font-size: 20px;",

    ", success number ")

      , tags$span(style="color:blue;font-weight:bold;font-size: 20px;", r) ,

       tags$span(style="color:black;font-weight:bold;font-size: 20px;",
     
     " is of interest"),
   
    
     ". "))
    

 })
  
  #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  
  

  renderPrint({
    
    p <- input$Px  # prob
    r <- input$sx  # rth success
    
    low =  input$x_rangex[1]
    xmax=  input$x_rangex[2]
    
    x <- 0:xmax
    
    x<-x[x>=r]
    succ <- choose(x-1,r-1)*p^r*(1-p)^(x-r)
    
    # combinations
    #n=10; k=2
    #factorial(n)/((factorial(n-k)*factorial(k)))
    ##another way
    #choose(n,k) 

    
    
    
    x <- 0:xmax
    fail <- choose(r+x-1,x)*p^r*(1-p)^(x)
     
    d <- dnbinom(x, size=r, prob=p)
     
      cat(paste0("Here we obtain the probability for the trial at which success number ",r," occurs\n"))
      print(x[x>=r])
      cat(paste0("Probability of ",r,"th success at trail x using upper equation\n"))
      print(succ)
      
      cat(paste0("\nHere we obtain the probability for the number of failed trials before the ", r," success:\n"))
      print(0:xmax)
      cat(paste0("Probability of x failed trials before ",r,"th success (lower equation)\n"))
      print(fail)
      
      cat("\nProbability using dnbinom function\n")
      print(d)
      
  })
  
 

```


QC {data-icon="fa-rocket"}
====================================



Column {.sidebar}
-----------------------------------------------------------------------

**The negative binomial distribution asks : what is the probability that the rth success will occur on the kth trial, where k varies from r to infinity, given a fixed r, and a fixed probability of success on each trial?**

```{r side3}

  #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 

  sliderInput('Px1', 'Probability of Success (p)', value=.4, #.5
                min = 0.01, max = 1, step=.01, ticks=F)
  
  sliderInput('sx1', 'No of successes (r)', value = c(2), #3
                min = 1, max = 50 ,step=1, ticks=F)

  sliderInput('x_rangex1', 'Plot x-range', value = c(0,10),
          min = 0, max = 80,step=5,ticks=F)
  
  sliderInput('y_rangex1', 'Plot y-range', value = c(0,.25),
          min = 0, max = 1,step=.05,ticks=F)

  checkboxInput('percx1','show stats on barplot', value=TRUE)

  #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
 

```

Recall that a binomial random variable is a count of the number of successes in n Bernoulli
trials. That is, the number of trials is predetermined, and the number of successes is random.
A negative binomial random variable is a count of the number of trials required to obtain r successes. That is, the number of successes is predetermined, and the number of trials is random


Column {.tabset .tabset-fade }
-----------------------------------

### Bar plot   


```{r}

renderPlot({

  par(mar=c(5.1, 4.1, 4.1, 7.1), mgp=c(3, 1, 0), las=0) # http://rfunction.com/archives/1302

  P <- input$Px1   # probability of success
  if (P==0) P=0.01
  s <- input$sx1   # th success

  # see references
  mu  <- s / P
  mu2 <- (s*P)/(1-P)
  v  <- s * (1 - P) / P^2
  v2 <- s * P/ (1 - P)^2
  ef <- s * (1 - P) / P

  #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  
  xmax=  input$x_rangex1[2]
  ymax = input$y_rangex1[2]

  xx <- c(seq(0,xmax,1)) 
  d <- dnbinom(0:max(xx), prob=P, size=s) #
   
  b <- barplot(d, 
               xlim=c(0,xmax+2),  
               ylim=c(0,ymax),
               main = paste0("Probability of ",s," successes on kth trial when probability of success is ",formatz2(P), ". Average number of trials \u03BC (r/p) = ",formatz2(mu) ,"  with variance r(1-p)/p^2 =",formatz2(v),"\nThe expected number of failures prior to r successes is r(1-p)/p = ",formatz2(ef),"\n"),
                             
                             
                             # 
                             # \nAverage number of successes rp/(1 − p) = ",formatz2(mu2),". Counting the number of successes given the number r of failures, the variance is rp/(1 − p)^2 = ",formatz2(v2),"\n"),
                                    
               col="orchid1", 
               ylab="Probability of success", 
               xlab=paste("Attempts for ",s," successes"),
               names.arg= as.character(xx+s))
 
 
    if(input$percx1) {
      
        x  <-0:length(b) # % onto top of bars
        y1 <- d + 0.02
        z  <- round(d,4) *100
        z  <- paste0(z,"%")
        text(x=b[x+1],y=(y1),labels=z, cex = 1)
  }
par(mar=c(5.1, 4.1, 4.1, 2.1), mgp=c(3, 1, 0), las=0)
 })
 
```

 
Row
---------------------------------------------------

### qc show calculations including simulation  {data-height=1200}


```{r qc1, include=TRUE, echo=TRUE, eval=TRUE}
  
  xx <- reactive({
    
        #~~~~~~~~~~~~~~~~~~~~~~~~~~~
        r <- input$sx1 
        p <- input$Px1 
        sims <- 1e4
        
        #~~~~~~~~~~~~~~~~~~~~~~~~~~~
        my_dat1 <- rnbinom(n = sims, size = r, prob = p) + r
        my_dat2 <- rnbinom(n = sims, size = r, prob = p)
        mu1s <- mean(my_dat1) 
        mu1e <- r / p
        
        v1e  <- r*(1-p)/p^2  
        v1s <- var(my_dat2)   
        #~~~~~~~~~~~~~~~~~~~~~~~~~~

        mu2s <- mean(my_dat2)   
        mu2e <- r*(1-p)/p     
        
        v2e  <- var(my_dat1)     
        #~~~~~~~~~~~~~~~~~~~~~~~~~~~
        my_dat3 <- rnbinom(n = sims, size = r, prob = 1-p)
        p1 <- 1-p
        
        mu3s <- mean(my_dat3)   # left last row
        mu3e <- r*(1-p1)/p1
        
        v3e  <- r*p/(1-p)^2  
        v3s  <- var(my_dat3)      
        
        #~~~~~~~~~~~~~~~~~~~~~~~~~~~
 
   return(list( mu1s=mu1s, mu1e=mu1e,
                mu2e=mu2e, mu2s=mu2s, 
                mu3e=mu3e, mu3s=mu3s, 
                v1e=v1e, v1s=v1s, 
                v2e=v2e,  
                v3e=v3e, v3s=v3s))
        
 
  })


```


```{r}

  renderPrint({
    
      # 1st row in title
      f <-  xx()$mu1s
      cat("1 The simulated average number of trials\n")
      print(f)
      f2 <-  xx()$mu1e
      cat("2 The average number of trials (r/p)\n")
      print(f2)
      
      f6 <-  xx()$v1s
      cat("3 The simulated variance of the expected number of failures prior to r successes\n")
      print(f6)
      f7 <-  xx()$v1e
      cat("4 The variance of the expected number of failures prior to r successes r(1 - p) / p^2\n")
      print(f7)
      
      ###2nd row in title
      f3 <-  xx()$mu2s
      cat("5 The simulated expected number of failures prior to r successes \n")
      print(f3)
      f4 <-  xx()$mu2e
      cat("6 The expected number of failures prior to r successes r(1-p)/p \n")
      print(f4)
      f5 <-  xx()$v2e
      cat("7 The simulated variance of expected number of failures prior to r successes  \n")
      print(f5)
      
      # reversing the initial probability..is this useful?
      f8 <-  xx()$mu3e
      cat("8 Average number of successes rp/(1-p)\n")
      print(f8)
      f9 <-  xx()$mu3s
      cat("9 Simulated average number of successes\n")
      print(f9)
      
      f10 <-  xx()$v3e
      cat("10 Variance counting the number r failures rp/(1-p)^2\n")
      print(f10)
      f11 <-  xx()$v3s
      cat("11 Simulated variance counting the number r failures\n")
      print(f11)
      
  })


```
 

### qc2 show calculations { data-height=1200}


```{r qc2, include=TRUE, echo=TRUE, eval=TRUE}


    qc2 <- reactive({
      
         z <-  rev_nb(input$Px1, input$sx1)  # my function
         mu = z[1][[1]]
         alpha_a = z[2][[1]]
         
         # code from when my ttests won't do code 
         value <-  0:1000000     
         freq  <-  e_dnbinom(value, alpha=alpha_a,mu=mu)*100
         mux   <-  sum(freq*value)/sum(freq)
         vax   <-  sum(freq*(value-mu)^2)/(sum(freq)-0) # I changed to 0 from 1
       
         return(list( mu=mux, v=vax ,  # simulation result
               mu1=mu, a=alpha_a  ))   # function result
       
    })
    
```

```{r qc2a }
    
    renderPrint({
      
        f <-  qc2()$mu
        cat("mu calculated from density function\n") 
        print(f)

        f2 <-  qc2()$v
        cat("Variance calculated from density function\n") 
        print(f2)
        
        f3 <-  qc2()$mu1
        cat("mu from rev_nb function\n") 
        print(f3)

        f4 <-  qc2()$a
        cat("alpha from rev_nb function\n") 
        print(f4)
        
        
    })
    
```


```{r qc3}
  
  HTML("\nConsider µ and sigma primary and r and p derived:")
   br()
 
 withMathJax(
                                           helpText('
                             $${r = \\frac {\\mu^2}{\\sigma^2-\\mu} }\\!$$'))
    
  br()
  
   HTML("We ignore the combinatorial motivation for
defining the negative binomial and instead view it simply as a model for count data.")

 withMathJax(
                                           helpText('
                             $${p = \\frac {r}{r+\\mu} }\\!$$'))
 
   br()

   withMathJax(
                                           helpText('
                             $${\\sigma^2 = \\mu + \\frac {1}{r}{\\mu^2} }\\!$$'))

  HTML("  With regard to negative binomial regression the variance can be written as (k is equal to r)")
                                       
  withMathJax(
                                           helpText('
                             $${{\\sigma^2 = }{{{\\mu} + \\frac{\\mu^2}{k}}}}\\!$$'))      
  
  HTML(" Sometimes this relationship is used")
                                       
  withMathJax(
                                           helpText('
                             $${{ }{{{\\alpha} = \\frac{1}{k}}}}\\!$$'))      
  
  
  HTML(" And then the variance is expressed as")
                                       
  withMathJax(
                                           helpText('
                             $${{\\sigma^2 =}{{{\\mu}  + {(\\alpha)}{ (\\mu^2)}}}}\\!$$'))  
   
  br()

  HTML(" In short, either the parameter k or its reciprocal alpha is referred to as the 'dispersion parameter' or 'shape parameter' or 'clustering coefficient' or 'heterogeneity' or 'heterogeneity (ancillary) parameter' or 'aggregation' parameter.  ")

  HTML("  These two formulations can introduce confusion, so it is important to clarify if a dispersion value is k or alpha.")


```



Gamma Poisson and Negative Binomial {data-icon="fa-rocket"}
====================================

Column {.sidebar}
-----------------------------------------------------------------------

**Inputs**

```{r input4}

  #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 


  sliderInput('nn', 'Poisson-Gamma mixture sims', value=10000, #.5
                min = 100, max = 100000, step=100, ticks=F)

  sliderInput('rx', 'size (r) ', value=2, #.5
                min = .1, max = 20, step=.1, ticks=F)
  
  sliderInput('betax', 'Beta', value = c(.666666666), #3
                min = .01, max = 5 , step=.01, ticks=F)

  sliderInput('x_rangex2x', 'Plot x-range', value = c(0,10),
          min = 0, max = 80,step=5,ticks=F)
  
  sliderInput('y_rangex2x', 'Plot y-range', value = c(0,.25),
          min = 0, max = 1.1 , step=.05,ticks=F)

  checkboxInput('percx2','show stats on barplot', value=TRUE)

  #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
 

```

Poisson-Gamma mixture example


Column 
-----------------------------------

### Generate a Poisson-Gamma mixture   


```{r}

#generate a Poisson-Gamma mixture


ff <- reactive({
  
   n <- input$nn
   r <- input$rx
   beta <- input$betax
 
 
   lambda <- rgamma(n, r, beta) #lambda is random
   #now supply the sample of lambda’s as the Poisson mean
   x <- rpois(n, lambda) #the mixture
  
   
   #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
   xmax=  input$x_rangex2x[2]
   ymax = input$y_rangex2x[2]

   y <- table(factor(x, levels = 0: xmax) )/n # pad out to xmax upper limit
   xx <- as.numeric(names(y) )
   d <- as.vector(y)
  
   #compare with negative binomial
   negbin <- round(dnbinom(0:max(xx), size=r, prob=beta/(1+beta)), 3)
   
   
   return(list( d=d, xmax=xmax, ymax=ymax, xx=xx, negbin=negbin))
  
  
})

 
renderPlot({

  par(mar=c(5.1, 4.1, 7.1, 7.1), mgp=c(3, 1, 0), las=0) # http://rfunction.com/archives/1302

  
  d <- ff()$d
  xx <- ff()$xx
  ymax <- ff()$ymax
  xmax <- ff()$xmax
   r <- input$rx
   beta <- input$betax
  
  b <- barplot(d, 
               xlim=c(0,xmax+2),  
               ylim=c(0,ymax),
               main = 
                 paste0("Empirical distribution (simulation) of the Poisson-Gamma mixture\nThe Poisson mean is rgamma(shape= ", r,", rate= ", beta,")\n"),
               col="orchid1", 
               ylab="Probability", 
               xlab=paste("Counts"),
               names.arg= as.character(xx))
 
 
    if(input$percx2) {
      
        x  <-0:length(b) # % onto top of bars
        y1 <- d + 0.03 # gap above bar
        z  <- round(d,3) *100
        z  <- paste0(z,"%")
        text(x=b[x+1],y=(y1),labels=z, cex = 1)
  }
par(mar=c(5.1, 4.1, 4.1, 2.1), mgp=c(3, 1, 0), las=0)
 })
 







# 
# negbin <- round(dnbinom(0:max(x), r, beta/(1+beta)), 3)
# se <- sqrt(negbin * (1 - negbin) / n)
#  round(rbind(mix, negbin, se), 3)
# 
#  
#  
 
 
 
 
```

### Negative binomial PMF


```{r}

renderPlot({

  par(mar=c(5.1, 4.1, 7.1, 7.1), mgp=c(3, 1, 0), las=0) # http://rfunction.com/archives/1302

  
 # d <- ff()$d
  xx <- ff()$xx
  ymax <- ff()$ymax
  xmax <- ff()$xmax
  d <- ff()$negbin
  r <- input$rx
  beta <- input$betax
   
   
   # n <- input$nn
   # r <- input$rx
   # beta <- input$betax
   # 
   # 
   # lambda <- rgamma(n, r, beta) #lambda is random
   # #now supply the sample of lambda’s as the Poisson mean
   # x <- rpois(n, lambda) #the mixture
   # #compare with negative binomial
   # 
   #  xmax=  input$x_rangex2x[2]
   #  ymax = input$y_rangex2x[2]
   # 
   #   y <- table(factor(x, levels = 0: xmax) )/n # pad out to xmax upper limit
   #   xx <- as.numeric(names(y) )
   #   d <-as.vector(y)
   
  zz<- rev_nb(prob=beta/(1+beta),size=r)
   
   
  b <- barplot(d, 
               xlim=c(0,xmax+2),  
               ylim=c(0,ymax),
               main = paste0("PMF of Negative Binomial (size= ",r," , prob= ",formatz3(beta/(1+beta))," )\nlet's calculate mu and alpha ",formatz2(zz[1][[1]]),", " ,formatz2(zz[2][[1]]),""),
               
               
               col="lightgreen", 
               ylab="Probability", 
               xlab=paste("Counts"),
               names.arg= as.character(xx))
 
 
    if(input$percx2) {
      
        x  <-0:length(b) # % onto top of bars
        y1 <- d + 0.04
        z  <- round(d,3) *100
        z  <- paste0(z,"%")
        text(x=b[x+1],y=(y1),labels=z, cex = 1)
  }
par(mar=c(5.1, 4.1, 4.1, 2.1), mgp=c(3, 1, 0), las=0)
 })
 





```

### Use the mu and alpha in the middle panel and plot this for completeness


```{r}


  
        renderPlot({
           
  
          
           par(mar=c(5.1, 4.1, 7.1, 7.1), mgp=c(3, 1, 0), las=0) # http://rfunction.com/archives/1302

  
 # d <- ff()$d
  xx <- ff()$xx
  ymax <- ff()$ymax
  xmax <- ff()$xmax
  r <- input$rx
  beta <- input$betax
   
  zz<- rev_nb(prob=beta/(1+beta),size=r)
          
          mu = zz[1][[1]]
          alpha_a = zz[2][[1]]
              
          #low =  input$x_range[1]
         

#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

  xx <- c(seq(0,xmax,1)) 

  if(alpha_a==0) {
    yb =    dpois(xx,mu)
  }else{
    yb=     e_dnbinom(xx,mu,alpha_a)
  }

  b <- barplot(yb, xlim=c(0,xmax+2), ylab = "Probability", xlab="Count of failed attempts (X-r)", col='lightgreen',
          ylim=c(0,ymax),
          main =  paste0("Negative Binomial \u03BC = ",mu," \u03B1 = ",formatz2(alpha_a),", variance = ", formatz3(mu+alpha_a*mu^2),""), # mu+alpha_a*mu^2* alpha_a
          names.arg= as.character(xx))
  
  if(input$percx2) {
    x  <- 0:length(b) # % onto top of bars
    y1 <- yb + 0.02
    z  <- round(yb,3) *100
    z  <- paste0(z,"%")
    text(x=b[x+1],y=(y1),labels=z, cex = 1)
  }
  par(mar=c(5.1, 4.1, 4.1, 2.1), mgp=c(3, 1, 0), las=0)
})


 

# 
# negbin <- round(dnbinom(0:max(x), r, beta/(1+beta)), 3)
# se <- sqrt(negbin * (1 - negbin) / n)
#  round(rbind(mix, negbin, se), 3)
# 
#  
#  
 
 
```
 
Row {data-height=150}
---------------------------------------------------

### Explanation {data-height=1200}


```{r qc2.1, include=TRUE, echo=FALSE, eval=TRUE}
  
 h5(htmlOutput("text1"))  

   output$text1 <- renderText({  # create interactive text t1  

    print(paste0(   
    
    tags$span(style="color:black;font-weight:bold;font-size: 20px;",   
               
               "This is an example of a continuous mixture. The negative binomial distribution is a mixture of Poisson(A) distributions, where A has a gamma distribution. Specifically, if (X|A = lambda) ∼ Poisson(lambda) and A ∼ Gamma(r, β), then X
has the negative binomial distribution with parameters r and p = β/(1 + β). This illustrates a method of sampling from a Poisson Gamma mixture and compares the sample with the negative binomial distribution") 
    
     , tags$span(style="color:blue;font-weight:bold;font-size: 20px;", 
                 
                 formatz3(input$beta) ),
   
        tags$span(style="color:black;font-weight:bold;font-size: 20px;", 

    ".") 

         ))
   })
   
```
   
Column 2
--------------------------------------------------   

### Agreement { data-height=800}

```{r qc2.2, include=TRUE, echo=FALSE, eval=TRUE}


 renderPrint({
       nb <- ff()$negbin
       pg <- ff()$d
       se <- sqrt(nb * (1 - nb) / input$nn) # proportion
       f <- round(rbind(pg, nb, se), 3)
       cat("The empirical distribution (first line below) of the mixture agrees very closely with the PMF of the negative binomial (second line), se of negative binomial line\n") 
       print(f)
    })


```

References {data-icon="fa-cog"}
====================================

Row {data-height=1400}
-------------------------------------

### References:

 - [wiki](https://en.wikipedia.org/wiki/Negative_binomial_distribution#Length_of_hospital_stay)

 - [Calculator](https://www.calculatoratoz.com/en/variance-of-negative-binomial-distributiond-calculator/Calc-5057?FormulaId=5057)

 - [Calculator2](https://www.anesi.com/negativebinomial.htm?p=0.5&r=3)

 <!-- - [Bookdown](https://bookdown.org/mpfoley1973/data-sci/negative-binomial.html) -->

 - [Calcualtor3](http://www.sfu.ca/~bjonoska/STAT380/week2/NegativeBinomial.R)

 - [Calculator4](https://www.calculatoratoz.com/en/mean-of-negative-binomial-distribution-calculator/Calc-5053?FormulaId=5053)

<!-- - [Tutorial](https://www.tutorialspoint.com/statistics/negative_binomial_distribution.html) -->

- [Nice definitions and examples using negative binomial distribution](https://www.trignosource.com/statistics/negative%20binomial%20distribution.html)

- [PMFs defined](http://www.math.ntu.edu.tw/~hchen/teaching/StatInference/notes/lecture16.pdf)

- [John D Cook's Notes on the Negative Binomial Distribution](https://www.johndcook.com/negative_binomial.pdf)

- [Negative binomial prob problem showing use of dnbinom 1](https://rpubs.com/mpfoley73/458738)

- [Negative binomial prob problem showing use of dnbinom 2](https://bookdown.org/mpfoley1973/data-sci/negative-binomial.html)

- [Statistical Computing with R, Maria L. Rizzo Section 3.5 Sums and Mixtures page 69](https://www.google.co.uk/books/edition/Statistical_Computing_with_R/jdjLBQAAQBAJ?hl=en&gbpv=0)

- [Poisson regression for linguists: A tutorial introduction to modelling count data with brms](https://compass.onlinelibrary.wiley.com/doi/epdf/10.1111/lnc3.12439)

